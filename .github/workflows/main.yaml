name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
    paths:
      - "app/**" # Solo se activa si cambias el cÃ³digo de la app
      - "k8s/**" # O si cambias los manifiestos

permissions:
  contents: write # Necesario para que el bot de GitHub pueda actualizar el YAML

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Login en Azure
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 2. Login en ACR
      - name: Login to ACR
        run: |
          az acr login --name ${{ secrets.ACR_NAME }}

      # 3. Build y Push de la imagen
      - name: Build and Push Image
        run: |
          IMAGE_TAG=${{ github.sha }}
          FULL_IMAGE_NAME=${{ secrets.ACR_LOGIN_SERVER }}/web-static:$IMAGE_TAG
          docker build -t $FULL_IMAGE_NAME ./app
          docker push $FULL_IMAGE_NAME
          echo "IMAGE_NAME=$FULL_IMAGE_NAME" >> $GITHUB_ENV

      # 4. Actualizar el manifiesto (Sed magic)
      - name: Update Kubernetes Manifest
        run: |
          # Reemplaza IMAGE_PLACEHOLDER por la imagen real con el tag del commit
          sed -i "s|IMAGE_PLACEHOLDER|${{ env.IMAGE_NAME }}|g" k8s/deployment.yaml

      # 5. Commit y Push del cambio para que Flux lo vea
      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/deployment.yaml
          git commit -m "Update image to ${{ github.sha }} [skip ci]"
          git push
